name: Build iOS Framework

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:  # 也支持手动触发

jobs:
  build-ios:
    name: Build iOS Framework
    runs-on: macos-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.24'
      
      - name: Install gomobile
        run: |
          go install golang.org/x/mobile/cmd/gomobile@latest
          go install golang.org/x/mobile/cmd/gobind@latest
          echo "GOPATH=$(go env GOPATH)" >> $GITHUB_ENV
          echo "GOBIN=$(go env GOPATH)/bin" >> $GITHUB_ENV
          echo "$(go env GOPATH)/bin" >> $GITHUB_PATH
      
      - name: Initialize gomobile
        run: |
          go get golang.org/x/mobile/bind
          gomobile init
      
      - name: Build iOS Framework
        run: |
          go mod tidy
          go mod download
          gomobile bind \
            -target=ios \
            -iosversion=15.0 \
            -o Warden_sdk.xcframework \
            -v github.com/jiangsu/warden_sdk/warden_sdk
      
      - name: Upload Framework artifact
        uses: actions/upload-artifact@v4
        with:
          name: warden-sdk-ios-xcframework
          path: Warden_sdk.xcframework
          retention-days: 30
      
      - name: Get Framework info
        run: |
          ls -lh Warden_sdk.xcframework
          echo "✅ iOS XCFramework 编译成功！"
